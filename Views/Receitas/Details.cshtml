@using Microsoft.VisualStudio.Web.CodeGenerators.Mvc.View
@model CookBook.ViewModels.ReceitaDetailsViewModel

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

@{
    ViewData["Title"] = Model.Receita.Titulo;
}

<h1>@Model.Receita.Titulo</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <img src="@Model.Receita.ImagemUrl" alt="Imagem da Receita" class="img-fluid rounded" />
        <p class="mt-2">**Tempo de Preparo:** @Model.Receita.TempoPreparoMinutos minutos</p>
        <p>**Criador:** @Model.Receita.User?.UserName</p>
        <p class="mt-2"><small class="text-muted">Criado em: @Model.Receita.DataCriacao.ToString("dd/MM/yyyy")</small></p>

        <div class="d-flex align-items-center mb-3">
            @if (User.Identity!.IsAuthenticated)
            {
                <button id="likeButton" 
                        data-receita-id="@Model.ReceitaId"
                        class="btn @(Model.IsLikedByCurrentUser ? "btn-danger" : "btn-outline-danger") me-2"
                        type="button">
                    <i class="fas fa-heart"></i>
                </button>
                <button id="saveButton" 
                        data-receita-id="@Model.ReceitaId"
                        class="btn @(Model.IsSavedByCurrentUser ? "btn-success" : "btn-outline-success") me-2"
                        type="button">
                    <i class="fas fa-bookmark"></i>
                </button>
            }
            
            <span id="likeCountDisplay" class="fs-5">@Model.TotalCurtidas</span>
            <span class="ms-1 text-muted">Curtidas</span>
        </div>

        <h3>Ingredientes</h3>
        <ul>
            @foreach (var ri in Model.Receita.ReceitaIngredientes!)
            {
                <li>**@ri.Quantidade** de @ri.Ingrediente.Nome</li>
            }
        </ul>
    </div>
    
    <div class="col-md-6">
        <h3>Instruções</h3>
        <p>@Model.Receita.Instrucoes</p>
    </div>
</div>

<hr />

<section class="mt-4">
    <h3>Comentários (@Model.Receita.Comentarios!.Count)</h3>

    @if (User.Identity!.IsAuthenticated)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5>Adicionar um Comentário:</h5>
                <form asp-action="AdicionarComentario" method="post">
                    <input type="hidden" asp-for="ReceitaId" /> 
                    
                    <div class="form-group">
                        <textarea asp-for="NovoComentarioTexto" class="form-control" rows="3" placeholder="Escreva seu comentário aqui..."></textarea>
                        <span asp-validation-for="NovoComentarioTexto" class="text-danger"></span>
                    </div>
                    
                    <button type="submit" class="btn btn-success mt-2">Enviar Comentário</button>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <a asp-controller="Account" asp-action="Login">Faça login</a> para deixar um comentário.
        </div>
    }

    <div class="comentarios-lista mt-4">
        @if (Model.Receita.Comentarios.Any())
        {
            @foreach (var comentario in Model.Receita.Comentarios.OrderByDescending(c => c.DataCriacao))
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <p class="card-text">@comentario.Conteudo</p>
                        <footer class="blockquote-footer">
                            Postado por: <strong>@comentario.User!.UserName</strong> em @comentario.DataCriacao.ToString("dd/MM/yyyy HH:mm")
                        </footer>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Nenhum comentário ainda. Seja o primeiro!</p>
        }
    </div>
</section>

<div>
    <a asp-action="Edit" asp-route-id="@Model.Receita.Id">Editar</a> |
    <a asp-action="Index">Voltar para a Lista</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        document.getElementById('likeButton')?.addEventListener('click', async function() {
            const button = this;
            const receitaId = button.getAttribute('data-receita-id');
            const url = `/Receitas/ToggleLike/${receitaId}`;
            const likeCountDisplay = document.getElementById('likeCountDisplay');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        // Inclui o token anti-forgery, se estiver configurado
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Atualiza o contador
                    likeCountDisplay.textContent = data.likeCount;

                    // Alterna o estilo do botão
                    if (data.isLiked) {
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-danger');
                    } else {
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-outline-danger');
                    }
                }
            } catch (error) {
                console.error('Erro ao curtir/descurtir:', error);
            }
        });

        document.getElementById('saveButton')?.addEventListener('click', async function() {
            const button = this;
            const receitaId = button.getAttribute('data-receita-id');
            const url = `/Receitas/ToggleSave/${receitaId}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Alterna o estilo do botão
                    if (data.isSaved) {
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-success');
                    } else {
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-success');
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar/desalvar:', error);
            }
        });
    </script>
}